# 15. Отладка и логирование

Для обеспечения стабильности, диагностики ошибок и разработки в KyroOS предусмотрены различные механизмы отладки и логирования.

## 15.1. Debug-интерфейсы

### Последовательный порт (Serial Port)

Основным низкоуровневым интерфейсом для отладки является последовательный порт (COM1).
-   **Ранняя инициализация:** Функции `serial_init()`, `serial_print()` и `serial_print_hex()` позволяют выводить сообщения на последовательный порт на очень ранних этапах загрузки ядра, еще до того, как будут доступны графические подсистемы или полная система логирования.
-   **Постоянный вывод:** Все сообщения системы логирования (`klog`) дублируются на последовательный порт. Это критически важно для анализа проблем, когда основной экран не работает или недоступен.

### Отладчик QEMU (GDB)

KyroOS активно разрабатывается и тестируется в виртуальной среде QEMU. QEMU предоставляет мощные возможности для отладки ядра:
-   **GDB-интеграция:** При запуске QEMU с флагами `-s -S` (например, `qemu-system-x86_64 -cdrom kyroos.iso -serial stdio -s -S`) QEMU открывает GDB-сервер.
-   **Удаленная отладка:** К этому серверу можно подключиться с помощью GNU Debugger (GDB) для пошагового выполнения кода ядра, установки точек останова, просмотра регистров и памяти. Это незаменимый инструмент для низкоуровневой отладки.

### Флаг `epstein` (Режим отладки)

В режиме отладочных сборок (Debug builds) существует флаг `epstein` (см. `src/kernel/epstein.h`), который может быть установлен в 1.
-   **Возможности:** Активация этого флага может предоставлять дополнительные функции для отладки, например, команду `panic <reason>` в системной оболочке, позволяющую искусственно инициировать Kernel Panic для тестирования обработчика.
-   **Ограничения:** Этот флаг **не должен быть активирован** в производственных сборках, так как может создавать уязвимости или нестабильность.

## 15.2. Логирование

Ядро KyroOS предоставляет централизованную систему логирования через функцию `klog()`.

### `klog()`

-   **Уровни логирования:** `klog()` поддерживает различные уровни важности сообщений (`LOG_DEBUG`, `LOG_INFO`, `LOG_WARN`, `LOG_ERROR`, `LOG_PANIC`), что позволяет фильтровать вывод.
-   **Форматированный вывод:** Поддерживает синтаксис, аналогичный `printf`, для удобства форматирования сообщений.
-   **Выходные потоки:** Сообщения `klog()` выводятся одновременно в три потока:
    1.  **Последовательный порт:** Для удаленной отладки и постоянной записи.
    2.  **Framebuffer-консоль:** На экране компьютера отображается текстовая консоль с сообщениями ядра, поддерживающая прокрутку.
    3.  **История в памяти:** Последние 10 сообщений сохраняются в циклическом буфере (`log_history`) в памяти ядра.

### Framebuffer-консоль

Функции (`klog_putchar`, `klog_print_str`, `console_clear`) предоставляют текстовую консоль на графическом Framebuffer. Она поддерживает базовые возможности:
-   Вывод символов и строк.
-   Перенос строк.
-   Прокрутка при заполнении экрана.

## 15.3. Crash-диагностика

KyroOS включает специализированный механизм для диагностики критических сбоев ядра, известный как Kernel Panic.

-   **Функция `panic()`:** Является центральной точкой для обработки всех невосстановимых ошибок ядра.
    -   При ее вызове сначала выводится краткое сообщение в последовательный порт.
    -   Затем вызывается `panic_screen_show()`, которая берет на себя управление графическим выводом.
-   **Экран Kernel Panic:** Этот специализированный графический экран предоставляет исчерпывающую информацию о состоянии системы в момент сбоя (подробно описано в **[17. Kernel Panic и критические ошибки ядра](./kernel_panics.md)**):
    -   **Сообщение о панике:** Передается в `panic()` и отображается крупным планом.
    -   **Дамп регистров:** Отображает значения всех основных регистров CPU в момент паники.
    -   **Трассировка стека:** Восстанавливает последовательность вызовов функций, предшествовавших сбою.
    -   **Информация о Page Fault:** Для исключений Page Fault декодируется код ошибки, и отображается адрес, вызвавший сбой.
    -   **Системная информация:** Версия ОС, данные о CPU, памяти.
    -   **История логов:** На экран выводятся последние 10 сообщений, сохраненных в `log_history`, что позволяет увидеть события, непосредственно предшествовавшие сбою.

Все эти меры позволяют разработчику получить максимально полную картину произошедшего, что значительно упрощает процесс отладки.
