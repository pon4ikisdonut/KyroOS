# 13. Сеть

Сетевая подсистема KyroOS реализована в виде многоуровневого стека протоколов, который обеспечивает взаимодействие с сетью, включая низкоуровневые операции с сетевым оборудованием и высокоуровневый API сокетов для пользовательских приложений.

## 13.1. Архитектура сетевого стека

Сетевой стек KyroOS имеет традиционную многоуровневую архитектуру:

1.  **Канальный уровень (Data Link Layer):** Представлен сетевыми драйверами (например, E1000). Отвечает за передачу данных в пределах одного сегмента сети (LAN), используя MAC-адреса. Включает протокол ARP.
2.  **Сетевой уровень (Network Layer):** Представлен протоколом IP (IPv4). Отвечает за маршрутизацию пакетов между различными сетями, используя IP-адреса.
3.  **Транспортный уровень (Transport Layer):** Представлен протоколами UDP и TCP. Отвечает за надежную или ненадежную доставку данных между приложениями на разных хостах.
4.  **Уровень сокетов (Sockets Layer):** Предоставляет стандартизированный программный интерфейс (API) для приложений пользовательского пространства для взаимодействия с сетевым стеком.

На текущем этапе **реализация сетевого ядра (`net_init`, `net_register_device`) находится непосредственно в исходном коде драйвера E1000 (`src/kernel/e1000.c`)**. Это указывает на тесную связь и ранний этап абстракции, где общие функции управления сетевыми устройствами пока не выделены в отдельный модуль.

### Путь пакета

#### Входящий пакет:

1.  **Драйвер сетевой карты (E1000):** При получении фрейма E1000 прерывает CPU. Обработчик прерывания (`e1000_interrupt_handler`) считывает фрейм из буферов DMA.
2.  **Демультиплексирование Ethernet:** Драйвер анализирует поле `EtherType` заголовка Ethernet:
    *   Если `ARP_ETHER_TYPE`, фрейм передается в `arp_handle_packet()`.
    *   Если `ETHERTYPE_IPV4`, фрейм передается в `ip_handle_packet()`.
3.  **IP-уровень:** `ip_handle_packet()` обрабатывает IP-заголовок (проверяет контрольную сумму, TTL) и демультиплексирует пакет на основе поля `Protocol`:
    *   Если `IP_PROTOCOL_UDP`, пакет передается в `udp_handle_packet()`.
    *   Если `IP_PROTOCOL_TCP`, пакет передается в `tcp_handle_packet()`.
    *   Если `IP_PROTOCOL_ICMP`, пакет передается в `icmp_handle_packet()`.
4.  **Транспортный уровень (UDP/TCP/ICMP):** Соответствующий обработчик анализирует заголовок своего протокола.
    *   Для UDP/TCP пакеты, предназначенные для открытых сокетов, передаются в `sock_handle_incoming_packet()`.
5.  **Уровень сокетов:** `sock_handle_incoming_packet()` находит соответствующий сокет (`socket_t`) на основе IP-адреса, порта и протокола, и помещает данные во внутренний буфер сокета. Если есть ждущий поток, он может быть разблокирован.

#### Исходящий пакет:

1.  **Пользовательское приложение:** Вызывает системный вызов (например, `SYS_SEND`), который через обертку `sock_send()` передает данные на уровень сокетов.
2.  **Уровень сокетов:** Функция `sock_send()` (или `sock_connect`) определяет, какой транспортный протокол (UDP/TCP) должен использоваться, и вызывает соответствующую протокол-специфичную функцию (например, `udp_send_packet` или `tcp_send_tcb`).
3.  **Транспортный уровень (UDP/TCP):** Формируется заголовок UDP/TCP. Затем вызывается `ip_send_packet()`.
4.  **IP-уровень:** `ip_send_packet()` формирует IP-заголовок, определяет MAC-адрес получателя через ARP-запросы (при необходимости) и вызывает функцию `send_packet` зарегистрированного сетевого устройства (например, `e1000_send_packet`).
5.  **Драйвер сетевой карты (E1000):** `e1000_send_packet()` формирует Ethernet-фрейм, помещает его в буфер DMA и инициирует передачу по сети.

## 13.2. Поддерживаемые протоколы

KyroOS поддерживает следующие сетевые протоколы:

-   **ARP (Address Resolution Protocol):** Для сопоставления IP-адресов с MAC-адресами.
-   **IP (Internet Protocol, IPv4):** Базовый протокол сетевого уровня.
-   **ICMP (Internet Control Message Protocol):** Протокол для обмена сообщениями об ошибках и других операционных сообщениях в сети (например, ping).
-   **UDP (User Datagram Protocol):** Простой, без установления соединения, ненадежный протокол транспортного уровня.
-   **TCP (Transmission Control Protocol):** Протокол транспортного уровня с установлением соединения, надежной доставкой и управлением потоком. Реализация является частичной, но функциональной, с поддержкой конечного автомата состояний TCP.
-   **DHCP (Dynamic Host Configuration Protocol):** Для автоматического получения IP-адреса и других сетевых настроек от DHCP-сервера.

## 13.3. Сетевые драйверы

На данный момент KyroOS поддерживает драйвер для **Intel E1000 Ethernet (Gigabit Ethernet Controller)**, который широко используется в виртуальных машинах (QEMU, VMware) и некоторых реальных системах.

-   **Регистрация:** Драйвер E1000 регистрирует себя в Device Manager и, после обнаружения и инициализации оборудования, регистрирует свою `net_dev_t` структуру в сетевой подсистеме (`net_register_device()`).
-   **Функциональность:** Предоставляет функции `send_packet` для отправки Ethernet-фреймов и обрабатывает входящие фреймы через свой обработчик прерываний.
