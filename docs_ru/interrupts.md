# 6. Прерывания и исключения

Архитектура обработки прерываний и исключений в KyroOS является основой для взаимодействия с оборудованием, обработки ошибок и реализации многозадачности. Она построена на основе Interrupt Descriptor Table (IDT) архитектуры x86-64.

## 6.1. Архитектура обработки

Процесс обработки прерывания или исключения проходит в несколько этапов, от аппаратного события до вызова высокоуровневого C-кода.

1.  **Событие:** Процессор (при возникновении исключения) или внешнее устройство (через контроллер прерываний PIC) инициирует прерывание.
2.  **Поиск в IDT:** Процессор использует номер вектора прерывания (0-255) как индекс в таблице IDT, чтобы найти соответствующий дескриптор шлюза (Gate Descriptor).
3.  **Переход к обработчику-заглушке:** Дескриптор указывает на низкоуровневый обработчик-заглушку (`ISR stub`) на ассемблере. В KyroOS для каждого вектора существует своя уникальная заглушка (`isr0`, `irq0` и т.д.).
4.  **Сохранение контекста:** Ассемблерная заглушка немедленно сохраняет на стеке полный контекст прерванного потока: все регистры общего назначения, а также `RIP`, `CS`, `RFLAGS`, `RSP`, `SS` (последние сохраняются процессором автоматически). Сохраненные данные формируют структуру `struct registers`.
5.  **Вызов C-диспетчера:** Заглушка вызывает общую C-функцию `isr_handler()`, передавая ей указатель на сохраненный на стеке контекст (`struct registers*`).
6.  **Высокоуровневая обработка:** C-диспетчер анализирует номер прерывания и передает управление соответствующему обработчику (например, драйверу клавиатуры или планировщику).
7.  **Возврат:** После завершения работы C-обработчика управление возвращается в ассемблерную заглушку, которая восстанавливает все сохраненные регистры и выполняет инструкцию `iretq`. Эта инструкция атомарно восстанавливает `RIP`, `CS`, `RFLAGS` и другие регистры, возвращая управление в прерванный код.

### Настройка IDT (`idt_init`)

В процессе инициализации ядра функция `idt_init` создает и загружает IDT:
-   Для каждого из 256 векторов создается дескриптор.
-   **Векторы 0-31** связываются с обработчиками **исключений CPU**.
-   **Векторы 32-47** связываются с обработчиками **аппаратных прерываний (IRQ)** от контроллера PIC.
-   **Вектор 128 (0x80)** связывается с обработчиком **системных вызовов**.
-   Для шлюзов ядра используется Interrupt Gate (тип `0x8E`), а для системных вызовов — Trap Gate (тип `0xEE`), который позволяет вызывать прерывание из пользовательского пространства (Ring 3).

### Диспетчеризация IRQ

Для аппаратных прерываний (клавиатура, мышь, диски) используется механизм регистрации. Драйверы могут зарегистрировать свою функцию-обработчик для конкретного номера IRQ с помощью `register_irq_handler()`. Когда C-диспетчер `isr_handler` получает IRQ, он находит и вызывает соответствующий зарегистрированный обработчик.

## 6.2. Таймеры

Системный таймер является ключевым компонентом для реализации вытесняющей многозадачности.
-   **Устройство:** KyroOS использует стандартный Programmable Interval Timer (PIT).
-   **Инициализация (`timer_init`):** Ядро программирует PIT на генерацию прерывания **IRQ 0** с частотой **100 Гц**.
-   **Обработка:** Обработчик IRQ 0 инкрементирует глобальный счетчик тиков (`ticks`) и, что самое важное, вызывает функцию `schedule()`. Именно этот периодический вызов планировщика обеспечивает переключение задач и иллюзию параллельного выполнения.

## 6.3. Исключения CPU

Исключения — это события, генерируемые процессором при обнаружении ошибочной ситуации. В KyroOS обработка исключений, возникших в режиме ядра, реализована максимально безопасно: любая такая ошибка считается фатальной и приводит к **Kernel Panic**.

Диспетчер `isr_handler` для векторов 0-31:
1.  Определяет тип исключения по его номеру.
2.  Находит соответствующее текстовое описание (например, "Page Fault", "General Protection Fault").
3.  Вызывает функцию `panic()`, передавая ей это описание и полный дамп регистров (`struct registers*`), сохраненный на стеке.

Этот подход не пытается восстановить систему после сбоя ядра, а вместо этого обеспечивает максимально полную диагностическую информацию для отладки.

## 6.4. Fault и Trap

В архитектуре x86-64 прерывания и исключения делятся на несколько типов. KyroOS использует два из них:

-   **Fault (Ошибка):** Это тип исключения, о котором сообщается *до* выполнения инструкции, вызвавшей ошибку. Адрес возврата (`RIP`), сохраняемый на стеке, указывает на саму ошибочную инструкцию. Это позволяет обработчику потенциально исправить причину (например, подгрузить страницу при Page Fault) и выполнить инструкцию заново. Исключения Page Fault и General Protection Fault являются примерами Fault.

-   **Trap (Ловушка):** Это тип исключения, о котором сообщается *после* выполнения инструкции. Адрес возврата указывает на инструкцию, *следующую* за той, что вызвала Trap. Это используется для отладки (прерывания по `int3`) и системных вызовов. В KyroOS системные вызовы через `int 0x80` реализованы как Trap, что позволяет программе пользователя продолжить выполнение после того, как ядро завершит свою работу.
