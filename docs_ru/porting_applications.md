# Портирование приложений на KyroOS

Портирование приложений на KyroOS включает их адаптацию к уникальной среде, которая значительно отличается от типичных систем Linux/Unix или Windows. KyroOS — это экспериментальное ядро с ограниченным набором системных вызовов и пользовательской библиотекой C.

## Понимание среды KyroOS

KyroOS стремится к простоте и эффективности. Ключевые аспекты, которые следует учитывать:

*   **Системные вызовы:** KyroOS предоставляет пользовательский набор системных вызовов. Вам потребуется обратиться к `src/include/syscall.h` для получения информации о доступных функциях и их сигнатурах. Стандартные системные вызовы POSIX, как правило, *не* доступны напрямую.
*   **Стандартная библиотека C:** Доступно подмножество стандартной библиотеки C, в основном реализованное в `userspace/lib/`. Просмотрите эти файлы, чтобы понять, какие функции предоставляются (например, манипуляции со строками, выделение памяти). Возможно, вам потребуется портировать отсутствующие функции или реализовать их самостоятельно.
*   **Точка входа пользовательского пространства:** Приложения обычно начинаются с пользовательской процедуры `_start` (см. `userspace/crt0.asm`), которая инициализирует среду перед вызовом `main`.
*   **Управление памятью:** Приложения пользовательского пространства работают в своем собственном виртуальном адресном пространстве. Выделение памяти (например, `malloc`, `free`) обрабатывается библиотекой пользовательского пространства KyroOS.
*   **Набор инструментов:** Приложения KyroOS компилируются с помощью `gcc-x86-64-linux-gnu` (или аналогичного кросс-компилятора) и компонуются с пользовательским сценарием компоновщика (`linker.ld` в корне проекта), который определяет расположение памяти для программ пользовательского пространства.

## Процесс портирования

1.  **Анализ зависимостей:** Определите все внешние библиотеки и системные вызовы, используемые вашим приложением.
    *   **Системные вызовы:** Сопоставьте существующие системные вызовы (например, `open`, `read`, `write`, `fork`, `exec`) с их эквивалентами KyroOS или определите, нужно ли их перереализовывать или заглушать.
    *   **Функции библиотеки C:** Проверьте, присутствуют ли все необходимые функции стандартной библиотеки C в `userspace/lib/`. Если нет, вам потребуется портировать их.
    *   **Сторонние библиотеки:** Большинство сложных сторонних библиотек (например, графические фреймворки, сетевые стеки) не будут напрямую портируемы без значительных усилий, так как они часто сильно зависят от среды, совместимой с POSIX. Вероятно, вам потребуется портировать их построчно или найти минимальные альтернативы.

2.  **Настройка системы сборки:**
    *   **Makefile:** Вероятно, вам потребуется пользовательский `Makefile` для вашего приложения, который использует `x86_64-elf-gcc` (или аналогичный кросс-компилятор) и компонуется с библиотекой пользовательского пространства KyroOS.
    *   **Сценарий компоновщика:** Убедитесь, что ваше приложение использует правильный сценарий компоновщика или определяет свои разделы соответствующим образом для макета памяти пользовательского пространства KyroOS.
    *   **Пути включения:** Убедитесь, что ваш компилятор может найти заголовки пользовательского пространства KyroOS (`src/include`).

3.  **Модификации кода:**
    *   **Обертки системных вызовов:** Напишите обертки для любых системных вызовов, которые требуют адаптации, или реализуйте пользовательские интерфейсы системных вызовов.
    *   **Код, специфичный для платформы:** Замените любой код, специфичный для платформы (например, вызовы Windows API, специфичные для Linux `ioctl`), на эквиваленты KyroOS или пользовательские реализации.
    *   **Параллелизм:** Если ваше приложение использует потоки или процессы, адаптируйте их к модели потоков KyroOS (см. `src/include/thread.h` и `src/kernel/thread.c`).

4.  **Тестирование и отладка:**
    *   **QEMU/VirtualBox:** Запустите ваше портированное приложение в KyroOS в виртуальной машине.
    *   **Журналирование ядра:** Используйте возможности журналирования ядра KyroOS (`log.h`) для отладки проблем в вашем приложении, если это необходимо.

## Пример

Примеры приложений пользовательского пространства можно найти в каталоге `userspace/` в [репозитории KyroOS](https://github.com/pon4ikisdonut/KyroOS). Приложения, такие как `init` и `shell`, служат хорошей отправной точкой для понимания процесса сборки и взаимодействия с ядром.
