# 9. Файловая система

Файловая система (ФС) в KyroOS имеет двухуровневую архитектуру, состоящую из абстрактного слоя VFS и конкретных реализаций ФС. На данный момент в системе сосуществуют две реализации: современная, иерархическая ФС в памяти (`KyroFS`) и устаревшая, плоская дисковая ФС (`fs_disk`).

## 9.1. Архитектура VFS (Virtual File System)

VFS — это абстрактный слой, который предоставляет единый интерфейс для работы с файлами и директориями для всех компонентов ядра и пользовательского пространства. Он позволяет поддерживать несколько разных файловых систем, скрывая детали их реализации.

### `vfs_node_t`

Центральной структурой VFS является `vfs_node_t` (аналог `inode` в Unix). Эта структура представляет любой объект в файловой иерархии (файл или директорию) и содержит:
-   Базовые метаданные: имя, флаги, размер.
-   Набор **указателей на функции** (`read`, `write`, `open`, `finddir` и т.д.).

Именно через эти указатели реализуется абстракция. Когда ядро вызывает, например, `vfs_read()`, VFS просто передает вызов функции `read`, указанной в `vfs_node_t` данного файла. Эта функция-обработчик предоставляется конкретным драйвером ФС, которому принадлежит файл.

### Регистрация и монтирование

-   **Регистрация:** Драйверы файловых систем могут регистрироваться в VFS при инициализации ядра, сообщая свое имя (например, "kyrofs") и функцию монтирования.
-   **Монтирование:** Системный вызов `mount` позволяет "прикрепить" новую файловую систему (например, с дискового раздела) к существующей директории в дереве VFS. VFS находит нужный драйвер по имени и вызывает его функцию монтирования, которая подготавливает ФС к работе и связывает ее с VFS.

## 9.2. Реализации файловых систем

### KyroFS (In-Memory Filesystem)

KyroFS — это простая, иерархическая файловая система, которая полностью работает в оперативной памяти.
-   **Назначение:** Используется как **корневая файловая система (`/`)**. При загрузке она наполняется системными директориями (`/bin`, `/etc`) и исполняемыми файлами, предварительно загруженными загрузчиком Limine.
-   **Структура:**
    -   **Директории:** Представлены как связный список `vfs_node_t`, где каждый узел списка — это файл или поддиректория.
    -   **Файлы:** Содержимое каждого файла хранится в динамически выделяемом буфере в куче ядра. При записи данных, если буфер переполняется, он перераспределяется с большим размером.
-   **Преимущества и недостатки:**
    -   **(+)** Очень высокая скорость работы, так как нет обращений к диску.
    -   **(-)** Не является персистентной: все изменения теряются при перезагрузке.

### fs_disk (On-Disk Filesystem)

`fs_disk` — это очень простая, **плоская (flat)** файловая система для дисковых разделов.
-   **Архитектура:** На данный момент **не интегрирована с VFS**. Представляет собой устаревшую реализацию с собственным API (`fs_create_file`, `fs_read_file`), которая не использует `vfs_node_t`.
-   **Структура на диске:**
    -   **Блок 0:** Суперблок с сигнатурой "KYRO" и базовой информацией о геометрии ФС.
    -   **Блоки 1..N:** Таблица файлов — непрерывный массив записей `fs_file_entry_t`.
    -   **Остальные блоки:** Область данных.
-   **Ограничения:**
    -   **Плоская структура:** Отсутствует поддержка директорий. Все файлы находятся в одном корневом пространстве.
    -   **Аллокация:** Используется примитивный счетчик "следующего свободного блока". Освобожденные блоки не переиспользуются. Файлы должны занимать непрерывные блоки, что ведет к сильной внешней фрагментации.
    -   **Максимум 32 файла** на всю ФС.

## 9.3. Метаданные

-   **VFS (`struct stat`):** VFS предоставляет стандартную структуру `stat`, содержащую основную информацию о файле: размер (`st_size`), режим (`st_mode` — тип файла) и номер inode (`st_ino`).
-   **KyroFS:** Метаданные хранятся непосредственно в структурах `vfs_node_t` в оперативной памяти.
-   **fs_disk (`fs_file_entry_t`):** Метаданные хранятся в таблице файлов на диске и включают имя файла, его размер, флаги и номер стартового блока данных.

## 9.4. Кэширование

-   **KyroFS:** Концепция кэширования неприменима, так как ФС уже находится в памяти.
-   **fs_disk:** Реализован **кэш таблицы файлов**. При монтировании вся таблица файлов считывается с диска в память. Все операции по созданию/удалению файлов производятся с этой копией в памяти. Обновленная таблица записывается обратно на диск только при размонтировании. **Кэширование блоков данных отсутствует**, все операции чтения и записи файлов идут напрямую на диск.

## 9.5. Права доступа

На данный момент в KyroOS **не реализована** полноценная модель прав доступа (чтение/запись/выполнение для пользователя/группы/остальных). Единственное различие, которое делает система — это тип файла (обычный файл или директория), информация о котором хранится во флаге `st_mode`.
