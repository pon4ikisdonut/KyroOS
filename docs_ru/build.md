# 16. Сборка и разработка

KyroOS использует стандартные инструменты GNU для сборки, ориентированные на кросс-компиляцию для архитектуры x86-64.

## 16.1. Инструменты сборки

Для сборки KyroOS требуется следующий набор инструментов:
-   **Кросс-компилятор GCC (GNU Compiler Collection):** `x86_64-linux-gnu-gcc` — основной компилятор для C-кода ядра и пользовательских приложений.
-   **NASM (Netwide Assembler):** Ассемблер для обработки низкоуровневых ассемблерных файлов (`.asm`).
-   **GNU Binutils:** Включает в себя архиватор (`x86_64-linux-gnu-ar`) для создания статических библиотек и компоновщик (`x86_64-linux-gnu-ld`) для линковки ELF-файлов.
-   **xorriso:** Инструмент для создания загрузочных ISO-образов.
-   **GNU Make:** Система автоматизации сборки, управляемая файлом `Makefile`.
-   **Среда сборки:** Оптимизирована для работы в Linux или Windows Subsystem for Linux (WSL).

## 16.2. Структура исходников

Проект имеет следующую ключевую структуру каталогов:

-   `src/`: Корневой каталог для всего исходного кода KyroOS.
    -   `src/boot/`: Низкоуровневые ассемблерные файлы (загрузка, переключение контекста, заглушки прерываний).
    -   `src/include/`: Общие заголовочные файлы для ядра и пользовательского пространства (API, определения структур).
    -   `src/kernel/`: Основные компоненты ядра (управление памятью, планировщик, драйверы, системные вызовы, сетевой стек).
    -   `src/tools/`: Исходный код системных утилит пользовательского пространства (coreutils, kpm, installer).
-   `userspace/`: Исходный код пользовательского пространства.
    -   `userspace/lib/`: Статические библиотеки пользовательского режима (упрощенная libc, графическая библиотека `kyroos_gfx`, текстовый UI `tui`).
    -   `userspace/game/`: Пример пользовательского приложения.
    -   `userspace/init/`: Программа `init`, запускаемая при старте ОС.
-   `modules/`: Исходный код загружаемых модулей ядра (LKM).
    -   `modules/hello_lkm/`: Пример простого LKM.
-   `limine/`: Исходный код загрузчика Limine (часто используется как подмодуль Git).
-   `build/`: Каталог для всех сгенерированных файлов: объектных файлов (`.o`), статических библиотек (`.a`), исполняемых файлов (`.elf`).
-   `doc/` и `docs/`: Документация проекта.

## 16.3. Процесс сборки

Основная цель `all` в `Makefile` выполняет полную сборку системы:
1.  Компилируется весь C-код ядра с использованием `x86_64-linux-gnu-gcc` и ассемблерный код с `nasm`.
2.  Создается статическая библиотека ядра (`libkyroos_kernel.a`) из объектных файлов.
3.  Ядро компонуется (`x86_64-linux-gnu-ld`) в исполняемый файл `kyroos.elf`, используя `linker.ld`.
4.  Компилируются пользовательские библиотеки и приложения.
5.  Создается загружаемый ISO-образ (`kyroos.iso`) с помощью `xorriso`, содержащий ядро, загрузчик Limine и все пользовательские исполняемые файлы.

### Флаги компиляции

-   **Флаги ядра (`K_CFLAGS`):**
    -   `-ffreestanding`, `-nostdlib`: Указывают на отсутствие стандартной библиотеки C.
    -   `-fno-stack-protector`, `-fno-stack-check`: Отключают защиту стека.
    -   `-mcmodel=kernel`: Специальная модель памяти для ядра.
    -   `-mno-red-zone`: Отключает "красную зону" стека, важную для безопасности прерываний.
    -   `-m64`, `-march=x86-64`, `-mabi=sysv`: Целевая архитектура x86-64, 64-битный режим, ABI System V.
    -   `-O2`: Уровень оптимизации.
    -   `-Wall`, `-Wextra`: Включение всех предупреждений компилятора.
-   **Флаги пользовательского пространства (`U_CFLAGS`):** Аналогичны флагам ядра, но могут включать другие опции, например, `-std=gnu11` для поддержки расширений GNU C.

## 16.4. Debug / Release конфигурации

На данный момент в системе **отсутствуют явные цели или переменные в `Makefile` для переключения между отладочной (`Debug`) и релизной (`Release`) конфигурациями** сборки.
-   **Оптимизация:** Флаги компиляции (`-O2`) по умолчанию указывают на сборку с оптимизацией, характерной для релизных версий.
-   **Отладочные символы:** Отладочные символы (`-g`) не включаются по умолчанию, что также типично для релизных сборок.
-   **Флаг `epstein`:** В коде ядра существует программный флаг `epstein` (см. `src/kernel/epstein.h`), который позволяет активировать некоторые функции отладки (например, ручное инициирование паники) на уровне кода. Его состояние должно управляться вручную (например, через `#define` в заголовочном файле).
Для выполнения отладки в QEMU (`make run`) необходимо вручную подключить GDB.