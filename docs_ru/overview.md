# KyroOS: Техническая спецификация

## 1. Введение

### 1.1. Назначение ОС

KyroOS — это экспериментальная, самописная операционная система общего назначения для 64-битной архитектуры x86-64. Она не основана на существующих ядрах, таких как Linux или BSD. Система спроектирована с нуля в образовательных целях для исследования и практической реализации ключевых концепций современных операционных систем.

### 1.2. Область применения

Основная область применения KyroOS — образовательная и исследовательская. Система служит платформой для изучения низкоуровневого программирования, архитектуры ядра, разработки драйверов и системных утилит.

KyroOS не предназначена для производственного (production) использования. Статус проекта — **alpha**, что подразумевает наличие известных и неизвестных ошибок, неполную реализацию функционала и возможную нестабильность.

### 1.3. Цели проектирования

При разработке KyroOS были поставлены следующие инженерные цели:

*   **Простота и читаемость кода:** Архитектура и код должны быть достаточно просты для изучения и понимания ключевых механизмов. Предпочтение отдается ясным и прямолинейным реализациям перед чрезмерно сложными оптимизациями.
*   **Расширяемость:** Архитектура должна позволять относительно простое добавление новых модулей, драйверов и системных вызовов.
*   **Соответствие современным концепциям:** Реализация должна отражать стандартные подходы, используемые в современных 64-битных ОС (виртуальная память, вытесняющая многозадачность, разделение на пространство ядра и пользователя).
*   **Самодостаточность:** Система должна быть минимально зависимой от внешних библиотек и сред выполнения на уровне ядра.

### 1.4. Архитектурные принципы

*   **Монолитное ядро:** Все основные сервисы ОС (управление процессами, памятью, файловой системой, драйверы) работают в едином адресном пространстве ядра для повышения производительности.
*   **Привилегированное ядро и непривилегированное пользовательское пространство:** Четкое разделение между режимом ядра (Ring 0) и режимом пользователя (Ring 3) для обеспечения защиты и стабильности системы.
*   **Вытесняющая многозадачность:** Планировщик по таймеру прерывает выполнение задач, обеспечивая псевдопараллельное выполнение нескольких процессов.
*   **Аппаратная абстракция:** Взаимодействие с оборудованием осуществляется через стандартизированные драйверные интерфейсы.

## 2. Общая архитектура

### 2.1. Тип ядра

Ядро KyroOS является **монолитным** с поддержкой загружаемых модулей (Loadable Kernel Modules, LKM).

Ключевые подсистемы, включая планировщик, VFS, сетевой стек и драйверы устройств, скомпилированы как единый бинарный файл и работают в одном адресном пространстве (Ring 0). Это обеспечивает высокую производительность за счет прямого вызова функций вместо медленных IPC-механизмов, характерных для микроядер. Поддержка LKM позволяет динамически (во время работы системы) загружать и выгружать код в ядро, например, для добавления поддержки нового оборудования.

### 2.2. Поддерживаемые архитектуры CPU

На данный момент KyroOS поддерживает только архитектуру **x86-64**.

Система использует 64-битный "длинный" режим (long mode), 4-уровневую структуру таблиц страниц (PML4) и регистры, специфичные для x86-64. Сборка кода ядра производится с флагами `-m64` и `-march=x86-64`. Ядро не использует расширения MMX и SSE для обеспечения простоты, но они могут использоваться в пользовательском пространстве.

### 2.3. Режимы работы процессора

KyroOS использует два уровня привилегий архитектуры x86-64:

*   **Режим ядра (Supervisor Mode, Ring 0):** В этом режиме выполняется все ядро, включая обработчики прерываний и системных вызовов, а также драйверы. Код в Ring 0 имеет полный доступ ко всему адресному пространству и всем инструкциям процессора.
*   **Режим пользователя (User Mode, Ring 3):** В этом режиме выполняются все пользовательские приложения (например, shell, утилиты). Код в Ring 3 изолирован: он имеет доступ только к своему собственному виртуальному адресному пространству и не может выполнять привилегированные инструкции. Взаимодействие с ядром происходит исключительно через механизм системных вызовов.

### 2.4. Модель многозадачности

KyroOS реализует **вытесняющую многозадачность** (Preemptive Multitasking) на основе временных интервалов (time-slicing).

*   **Сущности:** Система оперирует понятиями **процессов** и **потоков** (хотя текущая реализация может быть ближе к модели "один процесс — один поток").
*   **Планировщик:** Используется планировщик типа "Round-Robin". Каждому активному потоку выделяется квант времени. По истечении кванта системный таймер генерирует прерывание (IRQ), обработчик которого вызывает планировщик.
*   **Переключение контекста:** Планировщик выбирает следующий поток для выполнения и выполняет переключение контекста. Этот процесс включает сохранение состояния регистров текущего потока и загрузку состояния следующего потока.
*   **Состояния:** Потоки могут находиться в различных состояниях (например, `RUNNING`, `READY`, `BLOCKED`). Блокировка происходит при ожидании событий, таких как завершение операции ввода-вывода или освобождение ресурса синхронизации.
