# 14. Безопасность

Модель безопасности KyroOS, будучи экспериментальной операционной системой, сосредоточена на фундаментальных механизмах защиты, предоставляемых аппаратным обеспечением, для обеспечения изоляции процессов и защиты ядра от несанкционированного доступа.

## 14.1. Модель безопасности

Базовая модель безопасности KyroOS строится на концепции **изоляции ресурсов** и **привилегий**. Основные принципы:

-   **Разделение привилегий:** Строгое разделение между привилегированным режимом ядра (Ring 0) и непривилегированным режимом пользователя (Ring 3).
-   **Изоляция памяти:** Каждый процесс выполняется в собственном виртуальном адресном пространстве, предотвращая прямой доступ к памяти других процессов или ядра.
-   **Контролируемый доступ к ресурсам:** Все операции с системными ресурсами (файлы, устройства, сеть) доступны только через строго определенный API системных вызовов, которые валидируются ядром.

Отсутствие полноценной системы управления пользователями, групп, а также детальных прав доступа к файлам (chmod, chown) на данном этапе является значительным ограничением.

## 14.2. Изоляция процессов

Изоляция процессов является краеугольным камнем стабильности и безопасности многозадачной операционной системы. KyroOS реализует ее преимущественно через механизмы виртуальной памяти.

-   **Виртуальные адресные пространства:** Каждый процесс имеет собственное 4-уровневое виртуальное адресное пространство, описываемое уникальной таблицей PML4 (Page Map Level 4). Это означает, что виртуальный адрес `0x100000` в одном процессе может указывать на совершенно другой физический участок памяти, чем тот же адрес в другом процессе.
-   **Отсутствие прямого доступа:** Пользовательский процесс (работающий в Ring 3) не может получить прямой доступ к памяти других процессов или к памяти ядра. Любая такая попытка генерирует исключение (например, Page Fault или General Protection Fault), которое перехватывается ядром.
-   **Флаги защиты страниц:** Менеджер виртуальной памяти (VMM) устанавливает соответствующие флаги защиты в записях таблиц страниц:
    -   `PAGE_USER`: Разрешает доступ из пользовательского режима. Если этот флаг не установлен, доступ возможен только из режима ядра.
    -   `PAGE_WRITE`: Разрешает запись. Страницы с кодом программы обычно помечены как "только для чтения".
    -   `PAGE_NO_EXEC` (NX Bit): Запрещает выполнение кода со страниц, помеченных этим флагом (например, со стека или кучи), предотвращая некоторые виды атак, связанные с инъекцией кода.

## 14.3. Защита ядра

Защита ядра от вредоносных или ошибочных действий пользовательских приложений (и, в меньшей степени, от ошибок в самом ядре) является приоритетом.

-   **Пространство ядра:** Код и данные ядра всегда находятся в верхней половине виртуального адресного пространства, изолированно от пользовательской памяти.
-   **Привилегии Ring 0:** Код ядра выполняется на максимальном уровне привилегий (Ring 0), имея полный доступ ко всем системным ресурсам и инструкциям процессора. Пользовательские процессы (Ring 3) не могут выполнять привилегированные инструкции.
-   **Защита памяти ядра:** Страницы, содержащие код и данные ядра, отображаются с флагом `PAGE_SUPERVISOR` (что эквивалентно отсутствию `PAGE_USER` флага), что делает их недоступными из пользовательского режима.
-   **Контролируемый переход:** Единственный санкционированный путь перехода из пользовательского режима в режим ядра — это механизм **системных вызовов** (`int 0x80`). Все параметры, передаваемые пользовательским приложением в системный вызов, должны быть тщательно проверены ядром на валидность и безопасность, прежде чем будут использованы.
-   **Обработка критических ошибок:** Любое необработанное исключение (например, Page Fault или General Protection Fault) в режиме ядра немедленно приводит к **Kernel Panic**. Это предотвращает потенциальное повреждение данных или дальнейшую нестабильность системы, сигнализируя о фатальной ошибке.
-   **Отсутствие LKM для пользовательских приложений:** Несмотря на поддержку Loadable Kernel Modules, механизм загрузки модулей контролируется только ядром и не предоставляется пользовательским приложениям, что предотвращает инъекцию несанкционированного кода в ядро.
